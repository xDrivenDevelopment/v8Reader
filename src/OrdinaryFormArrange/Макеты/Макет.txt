Для начала заменяем все, что в кавычках.
Т.е. обрабатываем текст так:
1) Ищем все кавычки. То, что располагается между нечетным количеством кавычек с обеих сторон, считаем голым текстом и меняем на #TEXT<GUID>

2) Похожим образом обрабатываем и пары скобок. Тут можно проходить по несколько раз. Т.е. начнем с самых вложенных, их будем заменять на #PAIR<GUID>
Это делаем уже циклично.


